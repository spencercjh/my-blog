---
title: SSH session åˆ°åº•ä¼šåŠ è½½å“ªäº›ç¯å¢ƒå˜é‡ï¼Ÿ
description: æ·±å…¥ç†è§£ SSH ä¼šè¯ä¸­çš„ç¯å¢ƒå˜é‡åŠ è½½æœºåˆ¶
slug: ssh-session-env
tags: [linux]
hide_table_of_contents: false
authors: [spencercjh]
---

# SSH ä¼šè¯åˆ°åº•ä¼šåŠ è½½å“ªäº›ç¯å¢ƒå˜é‡ï¼Ÿ

å¾ˆå¤šç ”å‘åŒå­¦æ—¥å¸¸éœ€è¦ç™»å½•æœºå™¨ï¼ˆç‰©ç†æœºæˆ–è™šæ‹Ÿæœºï¼‰ï¼Œè¯»å®Œæœ¬æ–‡ä½ ä¸€å®šä¼šæœ‰æ”¶è·ã€‚
æœ¬æ–‡å¼€å¤´å…ˆæŠ›å‡º 3 ä¸ªé—®é¢˜ï¼Œè¶³ä»¥æ€»ç»“å…¨æ–‡å†…å®¹ï¼Œä¹Ÿèƒ½å¼•èµ·ä½ çš„å…´è¶£ï¼š

1. SSH ä¼šè¯å¯ä»¥åˆ†æˆå“ªäº›ç§ç±»ï¼Ÿ
2. `ssh your-name@your-host`ï¼Œç™»ä¸Šç›®æ ‡æœºå™¨åæ‰§è¡Œ `env` å‘½ä»¤è¾“å‡ºçš„ç¯å¢ƒå˜é‡æ˜¯ä»å“ªäº›æ–‡ä»¶åŠ è½½çš„ï¼Ÿ
3. `ssh your-name@your-host -- env`ï¼Œ`env` å‘½ä»¤è¾“å‡ºçš„ç¯å¢ƒå˜é‡æ˜¯ä»å“ªäº›æ–‡ä»¶åŠ è½½çš„ï¼Ÿ

_å…¨æ–‡ç»è¿‡ GPT-5 çš„æ¶¦è‰²ï¼Œä¸ strace ç»“æœåˆ†ææœ‰å…³å†…å®¹ç”± Claude Sonnet 4ï¼ˆæ²‰æ€ï¼‰å‚ä¸å®Œæˆã€‚_

<!-- truncate -->

## èƒŒæ™¯

æˆ‘å·¥ä½œå†…å®¹ä¸­çš„å¾ˆå¤§éƒ¨åˆ†æ˜¯ç»´æŠ¤ä¸€ä¸ªåŸºäº SSH çš„ä½œä¸šå¹³å°ã€‚åˆ«çœ‹è¿™ä¸ªå¹³å°å¬èµ·æ¥éå¸¸åŸå§‹å’Œç®€å•ï¼Œ
å®ƒæ”¯æ’‘äº†å…¨å…¬å¸çš„æœåŠ¡å™¨è¿ç»´ã€K8s Node è¿ç»´ã€å¤§æ•°æ®ç»„ä»¶è¿ç»´ã€æ•°æ®åº“è¿ç»´ã€æ½®æ±æ··éƒ¨ã€7 å±‚è´Ÿè½½å‡è¡¡é…ç½®åˆ†å‘ç­‰æ ¸å¿ƒåº•å±‚ä¸šåŠ¡ã€‚

ç”¨ä¸‹é¢è¿™å¹…å›¾æ¥å½¢å®¹éƒ½ä¸ä¸ºè¿‡ï¼š

![Dependency](https://imgs.xkcd.com/comics/dependency_2x.png)

2025 å¹´çš„ä»Šå¤©ï¼Œè®¸å¤šå¹³å°ç”¨æˆ·å¯¹ Linuxã€SSHã€Shell éƒ½ä¸ç”šäº†è§£ï¼Œä¹Ÿä¸ä¸Šç½‘æœç´¢ï¼Œç»å¸¸ç›´æ¥å‘æˆ‘æå‡ºè¿™æ ·çš„é—®é¢˜ï¼š

â€œæˆ‘çš„è„šæœ¬é€šè¿‡å ¡å’æœºç™»å½•åˆ°æœºå™¨ä¸Šåå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œä¸ºä»€ä¹ˆç”¨ä½ çš„å¹³å°å°±ä¼šæŠ¥é”™ï¼Œ**ç¯å¢ƒå˜é‡æ€ä¹ˆéƒ½æ‰¾ä¸åˆ°äº†å‘¢ï¼Ÿ**â€

## @flowblok çš„ç»“è®º

> æ„Ÿè°¢ [@Julia Evans] çš„æ¼«ç”»å°å†Œå­
> [ã€ŠThe Secret Rules of the Terminalã€‹](https://jvns.ca/blog/2025/06/24/new-zine--the-secret-rules-of-the-terminal/)ï¼Œ
> å…¶ä¸­æåˆ°äº†ä¸€ç¯‡åšå®¢ï¼š[ã€ŠShell startup scriptsã€‹](https://blog.flowblok.id.au/2013-02/shell-startup-scripts.html)
> ä½œä¸ºèµ„æ–™æ¥è¡¥å……è¯´æ˜ `.bashrc` å’Œ `.bash_profile` çš„åŒºåˆ«ã€‚

@flowblok åœ¨ [ã€ŠShell startup scriptsã€‹](https://blog.flowblok.id.au/2013-02/shell-startup-scripts.html) é‡Œç”»çš„å›¾å®åœ¨å¤ªå¤æ‚äº†ï¼Œä»–è¯´ä»–é€šè¯»äº†å„è·¯èµ„æ–™ï¼Œä¸æ˜è§‰å‰å•Šï¼

![complete-graph](assets/complete-graph.png)

æ€»ç»“ä¸Šå›¾ï¼Œ**åœ¨ SSH ç™»å½•å¯åŠ¨ Bash æ—¶**ï¼ŒåŠ è½½ä»€ä¹ˆç¯å¢ƒè„šæœ¬éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼š

- æ˜¯å¦æ˜¯ç™»å½• Shellï¼ˆlogin shellï¼‰ï¼Ÿè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ Bash æ‰§è¡Œ `shopt login_shell` æ¥åˆ¤æ–­ã€‚
- æ˜¯å¦æ˜¯äº¤äº’å¼ Shellï¼ˆinteractive shellï¼‰ï¼Ÿè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ Bash æ‰§è¡Œ `tty` æ¥åˆ¤æ–­ã€‚

## éªŒè¯å®éªŒ

è®©æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ @flowblok çš„ç»“è®ºã€‚

å®éªŒç¯å¢ƒï¼š

- æœºå™¨ï¼šOrbStack ä¸Šçš„ Ubuntu 25.04 è™šæ‹Ÿæœº
- Terminal Emulatorï¼šWarp

**ä¸åŒçš„ Linux å‘è¡Œç‰ˆä¼šæœ‰ä¸åŒçš„è¡¨ç°ï¼Œæ¬¢è¿å‘æˆ‘è¡¥å……ä¸åŒå‘è¡Œç‰ˆçš„ä¸åŒè¡¨ç°ã€‚**

### æ˜¯å¦ç™»å½•å’Œæ˜¯å¦äº¤äº’æ’åˆ—ç»„åˆå‚»å‚»åˆ†ä¸æ¸…æ¥š

æŸ¥é˜…èµ„æ–™æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œloginã€interactiveã€non-loginã€non-interactive å¯ä»¥ç»„åˆæˆ 4 ç§ä¸åŒçš„ Shell ä¼šè¯ã€‚

#### login + interactive

è¿™æ˜¯æœ€å¸¸è§çš„ä¼šè¯å½¢å¼ã€‚é€šè¿‡ `ssh $username@$hostname` ç™»å½•æœºå™¨åæ‰§è¡Œ `shopt login_shell` å’Œ `tty` èƒ½çœ‹åˆ° `login_shell on`
å’Œ `/dev/pts/X`ã€‚

#### login + non-interactive

ä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ç§ä¼šè¯ã€‚ä½¿ç”¨å‘½ä»¤
`ssh -i ~/.ssh/spencercjh_id_rsa root@192.168.139.193 -- 'bash --login -c "shopt login_shell; tty"'` å¯ä»¥å¼ºè¡Œåˆ¶é€ ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šè¾“å‡º
`login_shell on` å’Œ `not a tty`ã€‚

#### non-login + interactive

ä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ç§ä¼šè¯ã€‚`ssh $username@$hostname` åå†æ¬¡æ‰§è¡Œ `bash` æ‰“å¼€ä¸€ä¸ªä¼šè¯ï¼ˆæ³¨æ„æ²¡æœ‰ä½¿ç”¨ `--login` flagï¼‰ï¼Œç„¶å
`$ shopt login_shell: login_shell off`ï¼Œ`$ tty: /dev/pts/X`ã€‚

**ä½¿ç”¨ Warp çš„ Warpify SSH Sessions åŠŸèƒ½ä¹Ÿä¼šè¿›å…¥è¿™ç§ä¼šè¯**ã€‚å…¶åŸå› ä¼šåœ¨åæ–‡ä»‹ç»ã€‚

#### non-login + non-interactive

è¿™æ˜¯èƒŒæ™¯ä¸­æåˆ°çš„ä½œä¸šå¹³å°ä½¿ç”¨çš„ SSH ä¼šè¯ç±»å‹ï¼Œç”¨æˆ·ç–‘æƒ‘çš„åŸå› å°±åœ¨è¿™ç§ä¼šè¯ä¸å…¶ä»–ä¼šè¯çš„ç‰¹æ®Šæ€§ã€‚
æ‰§è¡Œå‘½ä»¤ `ssh $username@$hostname -- shopt login_shell; tty`ï¼Œè¯¥å‘½ä»¤ä¼šè¾“å‡º `login_shell off` å’Œ `not a tty`ã€‚

#### æ‹“å±•ï¼šSSH Session çš„åˆ›å»ºè¿‡ç¨‹

ä½¿ç”¨ `strace` çœ‹çœ‹ `sshd` åˆ›å»º SSH Session çš„è¿‡ç¨‹ï¼Œæ¥è§£é‡Šä¸ºä»€ä¹ˆ Warp çš„ Warpify SSH Sessions åŠŸèƒ½ä¼šå½±å“
`shopt login_shell` çš„ç»“æœã€‚

```shell
$ ps -aux | grep sshd
root         284  0.0  0.0   9836  3144 ?        Ss   01:55   0:00 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
$ sudo strace -f -e trace=execve -p 284
```

##### Warpify SSH Sessions è¡Œä¸º

![wapify-ssh-session](assets/warpify-ssh-session.png)

å¯ä»¥å‘ç° Warpify å®é™…ä¸Šæ˜¯æ›¿æ¢äº† SSH ç™»å½•å‘½ä»¤ï¼Œæ”¹æˆäº†å®ç°å¢å¼ºåŠŸèƒ½çš„ä¸€å¤§ä¸²è„šæœ¬ã€‚

è¿™æ—¶æ‰“å¼€ Warpify SSH Sessions åŠŸèƒ½ï¼Œå†ç™»å½•æœºå™¨ï¼Œstrace ç»“æœå¤ªå¤šäº†ï¼Œäº¤ç»™å¤§æ¨¡å‹åˆ†æä¸€ä¸‹ï¼š

è¿›ç¨‹æ ‘ç»“æ„ï¼š

```shell
sshd (PID 284) - ä¸» SSH å®ˆæŠ¤è¿›ç¨‹
    â”‚
    â”œâ”€â”€ sshd-session (PID 147767) - å¤„ç†å•ä¸ªè¿æ¥çš„ä¼šè¯è¿›ç¨‹
    â”‚
    â”œâ”€â”€ sh (PID 147779) - æ‰§è¡Œ MOTD è„šæœ¬
    â”‚   â””â”€â”€ run-parts + MOTD è„šæœ¬ä»¬ (PID 147780-147787)
    â”‚
    â””â”€â”€ bash (PID 147789) - ç”¨æˆ·çš„å®é™… Shell
        â””â”€â”€ å¤§é‡å­è¿›ç¨‹ (PID 147790+) - Warp Terminal çš„åŠŸèƒ½è¿›ç¨‹
```

è¿›ä¸€æ­¥æŸ¥çœ‹ strace è®°å½•å¯ä»¥å‘ç° Warpify SSH Session åï¼Œç”¨æˆ·çš„ Bash è¿›ç¨‹æ˜¯é€šè¿‡
`/usr/bin/bash", ["bash", "--rcfile", "/dev/fd/63"]` çš„æ–¹å¼å¯åŠ¨çš„ã€‚

![warpify-bash-process](assets/warpify-bash-process.png)

![warpify-bash-rcfile](assets/warpify-bash-rcfile.png)

##### åŸå§‹è¡Œä¸º

å…³é—­ Warp çš„ Warpify SSH Sessions åŠŸèƒ½ï¼Œä½¿ç”¨ `ssh $username@$hostname` ç™»å½•æœºå™¨ã€‚æœ‰äº†ä¸Šé¢çš„ç»éªŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ Bash è¿›ç¨‹çš„å¯åŠ¨æ–¹å¼ï¼š

![normal-bash-process](assets/normal-bash-process.png)

![normal-ssh-strace](assets/normal-ssh-strace.png)

å¯ä»¥å‘ç° Bash æ˜¯é€šè¿‡ `"/bin/bash", ["-bash"]` çš„æ–¹å¼å¯åŠ¨çš„ã€‚é˜…è¯» `man bash` å¯ä»¥å‘ç°ï¼š

> INVOCATION
>
> A login shell is one whose first character of argument zero is a -, or one started with the --login option.

ç»¼ä¸Šï¼Œ`-bash` ç­‰äº `--login`ï¼Œæ‰€ä»¥ `ssh $username@$hostname` çš„è¡Œä¸ºç­‰åŒäº `ssh $username@$hostname -- bash --login`ï¼Œ
å› æ­¤é»˜è®¤æƒ…å†µä¸‹æ‰“å¼€çš„ SSH Session æ˜¯ login shellã€‚è€Œ Warpify SSH Sessions åŠŸèƒ½ä¿®æ”¹äº†è¿™ä¸€è¡Œä¸ºï¼Œä¸¢å¤±äº† `--login` flagï¼Œæ‰€ä»¥
`shopt login_shell` ç»“æœæ˜¯ `off`ã€‚

### ç¯å¢ƒå˜é‡è„šæœ¬å¦‚ä½•åŠ è½½ï¼Ÿ

åœ¨ä¸‹é¢çš„æ–‡ä»¶ä¸­å¢åŠ  `export ENV_XXXX="this is XXXX"` çš„ç¯å¢ƒå˜é‡ï¼š

- `/etc/environment`ï¼ˆè¿™æ˜¯ @flowblok æ²¡æœ‰æåˆ°çš„å…¨å±€ç¯å¢ƒæ–‡ä»¶ï¼‰
- `/etc/profile`
- `/etc/bash.bashrc`
- `/root/.profile`
- `/root/.bash_login`
- `/root/.bash_profile`
- `/root/.bashrc`
- `/etc/profile.d/custom.sh`ï¼ˆè¿™æ˜¯ @flowblok æ²¡æœ‰æåˆ°çš„è‡ªå®šä¹‰è„šæœ¬ï¼‰

ç„¶ååˆ†åˆ«æ‰§è¡Œå¼€å¤´æåˆ°çš„ 2 ä¸ªå‘½ä»¤ï¼š

```shell
$ ssh $username@$hostname
$ env | grep ENV

$ ssh $username@$hostname -- 'env | grep ENV'
```

ç»“æœä¸ @flowblok å†™å¾—å…«ä¹ä¸ç¦»åäº†ã€‚

![exp-result-1](assets/exp-result-1.png)

#### ç™»å½•äº¤äº’ä¼šè¯

é¦–å…ˆ @flowblok æ²¡æœ‰æåˆ° `/etc/environment` æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸¤ç§ä¼šè¯éƒ½ä¼šåŠ è½½çš„ã€‚

å¯ä»¥å‘ç° login + interactive ä¼šè¯ä¼šåŠ è½½ç´«è‰²çº¿è·¯ä¸Šçš„æ–‡ä»¶ã€‚æŸ¥çœ‹ `/etc/profile` çš„å†…å®¹å¯ä»¥å‘ç°ï¼š

```shell
if [ -d /etc/profile.d ]; then
  for i in $(run-parts --list --regex '^[a-zA-Z0-9_][a-zA-Z0-9._-]*\.sh$' /etc/profile.d); do
    if [ -r $i ]; then
      . $i
    fi
  done
  unset i
fi
```

å®ƒä¼šåŠ è½½ `/etc/profile.d` ä¸­çš„è„šæœ¬ã€‚

å½“ `~/.profile`ã€`~/.bash_login` å’Œ `~/.bash_profile` åŒæ—¶å­˜åœ¨æ—¶ï¼Œåªä¼šåŠ è½½
`~/.bash_profile`ã€‚å¹¶ä¸”å®ƒä»¬è¿˜æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ¥å·¥ä½œï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥åšå®éªŒæ¥éªŒè¯ã€‚

![login-interactive-result-analyse](assets/exp-result-analyse-1.png)

å½“æˆ‘ä»¬æŠŠ `~/.bash_profile` ç§»èµ°åï¼Œ`~/.bash_login` å°±å¼€å§‹å·¥ä½œäº†ã€‚

![bash-login-work](assets/bash-login-work.png)

ç±»ä¼¼åœ°ï¼Œå½“æˆ‘ä»¬æŠŠ `~/.bash_login` ç§»èµ°åï¼Œ`~/.profile` å°±å¼€å§‹å·¥ä½œäº†ã€‚åœ¨æˆ‘è¿™ä¸ªå‘è¡Œç‰ˆä¸­ `~/.bashrc` é‡Œè¿˜ä¼šåŠ è½½ `~/.bashrc`ï¼š

```shell
# ~/.profile: executed by Bourne-compatible login shells.

export ENV_PROFILE="this is ~/.profile"
echo "this is ~/.profile"

if [ "$BASH" ]; then
  if [ -f ~/.bashrc ]; then
    . ~/.bashrc
  fi
fi
```

![home-profile-work](assets/home-profile-work.png)

è¿™ä¸€ç‚¹åœ¨ `man bash` ä¸­çš„ `INVOCATION` é‡Œå·²ç»æœ‰æ‰€æåŠï¼ˆå¯èƒ½ @flowblok ä¹Ÿå†™äº†è€Œæˆ‘æ²¡ä»”ç»†è¯»â€¦â€¦ï¼‰ã€‚

> When `bash` is invoked as an interactive login shell, or as a non-interactive shell with the `--login` option, it
> first reads and executes commands from the file `/etc/profile`, if that file exists. After reading that file, it looks
> for `~/.bash_profile`, `~/.bash_login`, and `~/.profile`, in that order, and reads and executes commands from the first
> one that exists and is readable. The --noprofile option may be used when the shell is started to inhibit this behavior.

æ–‡æ¡£é‡Œè¯´äº†ï¼Œåœ¨è¯»å– `/etc/profile` åï¼Œä¼šä¾æ¬¡è¯»å–å¹¶æ‰§è¡Œ `~/.bash_profile`ã€`~/.bash_login` å’Œ `~/.profile`ï¼Œå…³é”®åé¢è¿˜æœ‰åŠå¥ **from the first one that exists and is readable**ï¼Œè¿™æ„å‘³ç€å®ƒæ‰§è¡Œå®Œä¸€ä¸ªè„šæœ¬ä»¥åå°±ä¸ä¼šå†ç»§ç»­è¯»å–æ‰§è¡Œäº†ã€‚

#### éç™»å½•éäº¤äº’ä¼šè¯

`/etc/environment` çš„é—®é¢˜ä¸å†èµ˜è¿°ã€‚

è¿™é‡Œçš„è¯»å–é€»è¾‘ä¹Ÿåœ¨ `man bash` ä¸­çš„ `INVOCATION` æœ‰æåŠã€‚

> If bash determines it is being run non-interactively in this fashion, it reads and executes commands from
> /etc/bash.bashrc and ~/.bashrc, if these files exist and are readable.

å®éªŒè§‚å¯Ÿåˆ°çš„è¡Œä¸ºä¸ä¹‹ä¿æŒä¸€è‡´ã€‚

![non-login-non-interactive-session-analyse](assets/non-login-non-interactive-session-analyse-1.png)

## æ€»ç»“

1. SSH ä¼šè¯å¯ä»¥åˆ†æˆ 4 ç§ç±»å‹ï¼šlogin + interactiveã€login + non-interactiveã€non-login + interactiveã€non-login + non-interactiveã€‚
2. `ssh your-name@your-host` ä¼šåŠ è½½ `/etc/environment`ã€`/etc/profile`ï¼ˆä»¥åŠ `/etc/profile.d` ä¸‹çš„è„šæœ¬ï¼‰ã€`/etc/bash.bashrc`ã€`~/.bash_profile`ã€`~/.bash_login`ï¼ˆå¦‚æœ `~/.bash_profile` ä¸å­˜åœ¨ï¼‰ã€`~/.profile`ï¼ˆå¦‚æœ `~/.bash_profile` å’Œ `~/.bash_login` éƒ½ä¸å­˜åœ¨ï¼‰ã€‚
3. `ssh your-name@your-host -- $CMD` ä¼šåŠ è½½ `/etc/environment`ã€`/etc/bash.bashrc`ã€`~/.bashrc`ã€‚

## åè®°ï¼šç¯å¢ƒè„šæœ¬è¿˜ä¼šå½±å“ SFTP çš„å·¥ä½œ

ç»´æŠ¤ä½œä¸šå¹³å°çš„æ—¶å€™æˆ‘è¿˜ç»å¸¸è¢«ç”¨æˆ·æ‰”è¿‡æ¥è¿™æ ·çš„æ—¥å¿—ï¼š

```shell
get sftp client: packet too long
```

æœ€åæ’æŸ¥ä¸‹æ¥éƒ½æ˜¯ç”±äº **ç£ç›˜æ»¡äº†**ï¼Œå¯¼è‡´ä½œä¸šå¹³å°æ— æ³•æŠŠç”¨æˆ·è„šæœ¬åˆ†å‘åˆ°ç›®æ ‡æœºå™¨ä¸Šå»ã€‚

æ²¡æƒ³åˆ°åœ¨å…¬å¸é‡Œåšä¸Šè¿°å®éªŒçš„æ—¶å€™ï¼Œä¹Ÿå¤ç°äº†è¿™æ ·çš„é—®é¢˜ã€‚

å½“æˆ‘åœ¨ `~/.bashrc` ä¸­å¢åŠ  `echo "YOU CAN't echo here"` åï¼ŒSFTP å°±æŠ¥é”™äº†ã€‚

```shell
sftp -i ~/.ssh/spencercjh_id_rsa root@192.168.139.193
Warning: Permanently added '192.168.139.193' (ED25519) to the list of known hosts.
Received message too long 1498371360
Ensure the remote shell produces no output for non-interactive sessions.
```

### SFTP æ˜¯å¦‚ä½•å·¥ä½œçš„

è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä½¿ç”¨ strace + å¤§æ¨¡å‹åˆ†æã€‚

```shell
$ strace -f -e trace=write,read,execve -p 284
```

#### æ‰§è¡Œè¿‡ç¨‹

```shell
å®¢æˆ·ç«¯                SSH è¿æ¥               æœåŠ¡ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sftp    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ åŠ å¯†é€šé“ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ sshd (148831)   â”‚
â”‚ client  â”‚          â”‚         â”‚          â”‚      â†“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ sshd (148842)   â”‚ â† SSH session
                                          â”‚      â†“          â”‚
                                          â”‚ bash (148843)   â”‚ â† Shell å¯åŠ¨å™¨
                                          â”‚      â†“          â”‚
                                          â”‚ sftp-server     â”‚ â† çœŸæ­£çš„ SFTP æœåŠ¡
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

```shell
# 1. SSH åè®®æ¡æ‰‹
[pid 148831] write(4, "SSH-2.0-OpenSSH_9.9p1 Ubuntu-3ub"..., 41) = 41
[pid 148831] read(4, "SSH-2.0-OpenSSH_9.9", 21) = 21
# 2. å¯†é’¥äº¤æ¢
[pid 148832] write(4, "\0\0\4\214\n\24\n\20\271\355\33\22...", 1168) = 1168
# 3. ç”¨æˆ·è®¤è¯
[pid 148832] write(6, "\0\0\0\4root", 8) = 8

# 4. è¯·æ±‚ SFTP å­ç³»ç»Ÿ
[pid 148842] write(6, "\0\0\0!q", 5) = 5
[pid 148842] write(6, "\0\0\0\34/usr/lib/openssh/sftp-server", 32) = 32

# 5. ğŸ¯ åˆ›å»º Shell æ¥å¯åŠ¨ sftp-server
[pid 148843] execve("/bin/bash", ["bash", "-c", "/usr/lib/openssh/sftp-server"], ...)

# 6. Shell è¯»å–é…ç½®æ–‡ä»¶
[pid 148843] read(3, "# System-wide .bashrc file for i "..., 2371) = 2371
[pid 148843] read(3, "# ~/.bashrc: executed by bash(1)"..., 3170) = 3170

# 7. ğŸ’¥ æ‰§è¡Œä½ çš„ echo è¯­å¥
[pid 148843] write(1, "YOU CAN't echo here\n", 20) = 20

# 8. SFTP è¿›ç¨‹è¯»å–åˆ°è¢«æ±¡æŸ“çš„æ•°æ®
[pid 148842] read(10, "YOU CAN't echo here\n", 32768) = 20

# 9. Shell å¯åŠ¨çœŸæ­£çš„ sftp-server
[pid 148843] execve("/usr/lib/openssh/sftp-server", ...)

# 10. ğŸ’€ SFTP è¿›ç¨‹å› åè®®é”™è¯¯é€€å‡º
[pid 148842] +++ exited with 255 +++

```

å¯ä»¥çœ‹åˆ°ï¼Œç”±äºä½¿ç”¨äº† `"/bin/bash", ["bash", "-c", "/usr/lib/openssh/sftp-server"]` å¯åŠ¨ sftp-serverï¼Œè¿™ä¸ªä¼šè¯ä¼šæŒ‰ç…§ä¸Šé¢ non-login & non-interactive çš„è·¯å¾„ï¼ŒåŠ è½½ `/etc/bash.bashrc` å’Œ `~/.bashrc`ã€‚

#### SFTP åè®®

```shell
# SFTP å®¢æˆ·ç«¯å‘é€åˆå§‹åŒ–æ¶ˆæ¯
[pid 148842] write(9, "\0\0\0\5\1\0\0\0\3", 9) = 9
                     â†‘é•¿åº¦=5 â†‘ç±»å‹=1 â†‘ç‰ˆæœ¬=3
# Shell çš„è¾“å‡ºç ´åäº†å“åº”æµ
[pid 148843] write(1, "YOU CAN't echo here\n", 20) = 20
# SFTP è¿›ç¨‹è¯»å–åˆ°æ··åˆæ•°æ®
[pid 148842] read(10, "YOU CAN't echo here\n", 32768) = 20

# å®¢æˆ·ç«¯æœŸæœ›çš„æ ¼å¼ï¼š
æ­£ç¡®: [é•¿åº¦4å­—èŠ‚][æ¶ˆæ¯ç±»å‹][æ•°æ®...]
ä¾‹å¦‚: 0x00000009   0x02      [ç‰ˆæœ¬å“åº”æ•°æ®]
# å®é™…æ”¶åˆ°çš„æ•°æ®ï¼š
é”™è¯¯: "YOU CAN't echo here\n" + [æ­£ç¡®çš„ SFTP å“åº”]
      â†‘è¢«è§£é‡Šä¸ºé•¿åº¦å­—æ®µ
# ASCII "YOU " = 0x594F5520 = 1498371360
# è¿™å°±æ˜¯ "packet too long 1498371360" çš„æ¥æºï¼
```

ç»¼ä¸Šï¼Œåªè¦åœ¨ SFTP å·¥ä½œçš„è¿‡ç¨‹ä¸­ç³»ç»Ÿæœ‰ä»»ä½•æ„å¤–è¾“å‡ºï¼Œéƒ½ä¼šç ´åå…¶äºŒè¿›åˆ¶åè®®ï¼Œå¯¼è‡´æŠ¥é”™ get sftp client: packet too longã€‚

## åè®°ï¼šå˜æ¸… tty ç›¸å…³æ¦‚å¿µ

- TTY: Teletypewriter
- PTY: Pseudo Terminal
- PTS: Pseudo Terminal Slave

```shell
Terminal Emulator â†â†’ PTY Slave â†â†’ TTY Driver â†â†’ PTY Master â†â†’ Program (SSHD)
```

æ­£å¦‚ Julia Evans æ‰€è¨€ï¼Œç»ˆç«¯æœ‰å…³çš„çŸ¥è¯†å¤ªé›¶æ•£äº†ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é˜…è¯»ï¼š[ã€ŠThe Secret Rules of the Terminalã€‹](https://jvns.ca/blog/2025/06/24/new-zine--the-secret-rules-of-the-terminal/)ã€‚

**ä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šç»§ç»­å’Œ tty æœ‰å…³ï¼Œè¯¦è§£ `kubectl exec`ï¼Œå°½æƒ…æœŸå¾…ã€‚**
